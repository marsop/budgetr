@page "/sync"
@using Budgetr.Shared.Services
@using Microsoft.JSInterop
@inject ITimeTrackingService TimeService
@inject IJSRuntime JS

<div class="sync-page">
    <h2 class="page-title">Sync</h2>
    
    <div class="sync-tabs">
        <button class="tab-button @(activeTab == "local" ? "active" : "")" @onclick="@(() => activeTab = "local")">
            <span class="tab-icon">üìÅ</span>
            <span>Local</span>
        </button>
        <button class="tab-button @(activeTab == "gdrive" ? "active" : "")" @onclick="@(() => SwitchToGoogleDrive())">
            <span class="tab-icon">‚òÅÔ∏è</span>
            <span>Google Drive</span>
        </button>
    </div>
    
    @if (activeTab == "local")
    {
        <div class="sync-section">
            <h3>Export Data</h3>
            <p class="section-description">Download all your data (meters and events) as a JSON file.</p>
            <button class="sync-button export-btn" @onclick="ExportData" disabled="@isExporting">
                <span class="btn-icon">üì•</span>
                <span>@(isExporting ? "Exporting..." : "Export Data")</span>
            </button>
        </div>
        
        <div class="sync-section">
            <h3>Import Data</h3>
            <p class="section-description">Replace your current data by importing a JSON file.</p>
            
            <div class="file-input-container">
                <input type="file" 
                       id="importFileInput" 
                       accept=".json" 
                       @ref="fileInput" 
                       @onchange="OnFileSelected"
                       class="file-input" />
                <label for="importFileInput" class="file-label">
                    <span class="btn-icon">üìÅ</span>
                    <span>Choose File</span>
                </label>
            </div>
            
            @if (!string.IsNullOrEmpty(selectedFileName))
            {
                <div class="selected-file">
                    <span>Selected: @selectedFileName</span>
                </div>
                <button class="sync-button import-btn" @onclick="ImportData" disabled="@isImporting">
                    <span class="btn-icon">üì§</span>
                    <span>@(isImporting ? "Importing..." : "Import Data")</span>
                </button>
            }
        </div>
    }
    else if (activeTab == "gdrive")
    {
        <div class="sync-section">
            <h3>‚òÅÔ∏è Google Drive Sync</h3>
            <p class="section-description">Backup and restore your data using Google Drive.</p>
            
            @if (!isGoogleDriveConfigured)
            {
                <div class="config-section">
                    <p class="config-note">
                        To use Google Drive sync, you need to configure an OAuth Client ID from 
                        <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console</a>.
                    </p>
                    <div class="config-input-group">
                        <label for="clientIdInput">OAuth Client ID:</label>
                        <input type="text" 
                               id="clientIdInput" 
                               @bind="clientIdInput" 
                               placeholder="Enter your Client ID"
                               class="config-input" />
                    </div>
                    <button class="sync-button config-btn" @onclick="ConfigureGoogleDrive" disabled="@string.IsNullOrWhiteSpace(clientIdInput)">
                        <span class="btn-icon">‚öôÔ∏è</span>
                        <span>Configure</span>
                    </button>
                </div>
            }
            else if (!isGoogleDriveSignedIn)
            {
                <button class="sync-button google-btn" @onclick="SignInWithGoogle" disabled="@isSigningIn">
                    <span class="btn-icon">üîë</span>
                    <span>@(isSigningIn ? "Signing in..." : "Sign in with Google")</span>
                </button>
                
                <div class="reconfigure-section">
                    <button class="link-button" @onclick="ShowReconfigure">Reconfigure Client ID</button>
                </div>
            }
            else
            {
                <div class="signed-in-info">
                    <span class="check-icon">‚úÖ</span>
                    <span>Signed in as <strong>@googleUserEmail</strong></span>
                </div>
                
                @if (lastBackupTime.HasValue)
                {
                    <div class="backup-info">
                        <span class="info-icon">‚ÑπÔ∏è</span>
                        <span>Last backup: @lastBackupTime.Value.ToLocalTime().ToString("g")</span>
                    </div>
                }
                
                <div class="gdrive-actions">
                    <button class="sync-button backup-btn" @onclick="BackupToGoogleDrive" disabled="@isBackingUp">
                        <span class="btn-icon">‚¨ÜÔ∏è</span>
                        <span>@(isBackingUp ? "Backing up..." : "Backup to Drive")</span>
                    </button>
                    
                    <button class="sync-button restore-btn" @onclick="RestoreFromGoogleDrive" disabled="@isRestoring">
                        <span class="btn-icon">‚¨áÔ∏è</span>
                        <span>@(isRestoring ? "Restoring..." : "Restore from Drive")</span>
                    </button>
                </div>
                
                <div class="signout-section">
                    <button class="link-button signout" @onclick="SignOutFromGoogle">Sign Out</button>
                </div>
            }
        </div>
    }
    
    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <div class="status-message @statusClass">
            @statusMessage
        </div>
    }
</div>

@code {
    private ElementReference fileInput;
    private string? selectedFileName;
    private bool isExporting;
    private bool isImporting;
    private string? statusMessage;
    private string statusClass = "";
    
    // Tab state
    private string activeTab = "local";
    
    // Google Drive state
    private bool isGoogleDriveConfigured;
    private bool isGoogleDriveSignedIn;
    private string? googleUserEmail;
    private string? clientIdInput;
    private bool isSigningIn;
    private bool isBackingUp;
    private bool isRestoring;
    private DateTimeOffset? lastBackupTime;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Try to auto-initialize Google Drive if previously configured
            await TryInitializeGoogleDrive();
        }
    }

    private async Task TryInitializeGoogleDrive()
    {
        try
        {
            var savedClientId = await JS.InvokeAsync<string?>("localStorage.getItem", "budgetr_gdrive_clientid");
            if (!string.IsNullOrEmpty(savedClientId))
            {
                await JS.InvokeVoidAsync("googleDriveInterop.initialize", savedClientId);
                isGoogleDriveConfigured = true;
                isGoogleDriveSignedIn = await JS.InvokeAsync<bool>("googleDriveInterop.isSignedIn");
                
                if (isGoogleDriveSignedIn)
                {
                    googleUserEmail = await JS.InvokeAsync<string?>("googleDriveInterop.getUserEmail");
                    await RefreshBackupInfo();
                }
                
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to auto-initialize Google Drive: {ex.Message}");
        }
    }

    private async Task SwitchToGoogleDrive()
    {
        activeTab = "gdrive";
        statusMessage = null;
        
        if (isGoogleDriveConfigured && isGoogleDriveSignedIn)
        {
            await RefreshBackupInfo();
        }
    }

    private async Task ConfigureGoogleDrive()
    {
        if (string.IsNullOrWhiteSpace(clientIdInput))
            return;
            
        statusMessage = null;
        
        try
        {
            await JS.InvokeVoidAsync("localStorage.setItem", "budgetr_gdrive_clientid", clientIdInput);
            await JS.InvokeVoidAsync("googleDriveInterop.initialize", clientIdInput);
            isGoogleDriveConfigured = true;
            statusMessage = "Google Drive configured successfully!";
            statusClass = "success";
        }
        catch (Exception ex)
        {
            statusMessage = $"Configuration failed: {ex.Message}";
            statusClass = "error";
        }
    }

    private void ShowReconfigure()
    {
        isGoogleDriveConfigured = false;
        clientIdInput = null;
        statusMessage = null;
    }

    private async Task SignInWithGoogle()
    {
        isSigningIn = true;
        statusMessage = null;
        StateHasChanged();
        
        try
        {
            var success = await JS.InvokeAsync<bool>("googleDriveInterop.signIn");
            if (success)
            {
                isGoogleDriveSignedIn = true;
                googleUserEmail = await JS.InvokeAsync<string?>("googleDriveInterop.getUserEmail");
                await RefreshBackupInfo();
                statusMessage = "Signed in successfully!";
                statusClass = "success";
            }
            else
            {
                statusMessage = "Sign in was cancelled.";
                statusClass = "error";
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Sign in failed: {ex.Message}";
            statusClass = "error";
        }
        finally
        {
            isSigningIn = false;
            StateHasChanged();
        }
    }

    private async Task SignOutFromGoogle()
    {
        try
        {
            await JS.InvokeVoidAsync("googleDriveInterop.signOut");
            isGoogleDriveSignedIn = false;
            googleUserEmail = null;
            lastBackupTime = null;
            statusMessage = "Signed out successfully.";
            statusClass = "success";
        }
        catch (Exception ex)
        {
            statusMessage = $"Sign out failed: {ex.Message}";
            statusClass = "error";
        }
        StateHasChanged();
    }

    private async Task RefreshBackupInfo()
    {
        try
        {
            var lastModified = await JS.InvokeAsync<string?>("googleDriveInterop.getBackupLastModified");
            if (!string.IsNullOrEmpty(lastModified) && DateTimeOffset.TryParse(lastModified, out var parsed))
            {
                lastBackupTime = parsed;
            }
            else
            {
                lastBackupTime = null;
            }
        }
        catch
        {
            lastBackupTime = null;
        }
    }

    private async Task BackupToGoogleDrive()
    {
        isBackingUp = true;
        statusMessage = null;
        StateHasChanged();
        
        try
        {
            var json = TimeService.ExportData();
            await JS.InvokeVoidAsync("googleDriveInterop.saveBackup", json);
            await RefreshBackupInfo();
            statusMessage = "Backup completed successfully!";
            statusClass = "success";
        }
        catch (Exception ex)
        {
            statusMessage = $"Backup failed: {ex.Message}";
            statusClass = "error";
        }
        finally
        {
            isBackingUp = false;
            StateHasChanged();
        }
    }

    private async Task RestoreFromGoogleDrive()
    {
        isRestoring = true;
        statusMessage = null;
        StateHasChanged();
        
        try
        {
            var content = await JS.InvokeAsync<string?>("googleDriveInterop.getLatestBackup");
            
            if (string.IsNullOrEmpty(content))
            {
                statusMessage = "No backup found in Google Drive.";
                statusClass = "error";
            }
            else
            {
                await TimeService.ImportDataAsync(content);
                statusMessage = "Data restored successfully from Google Drive!";
                statusClass = "success";
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Restore failed: {ex.Message}";
            statusClass = "error";
        }
        finally
        {
            isRestoring = false;
            StateHasChanged();
        }
    }

    private async Task ExportData()
    {
        isExporting = true;
        statusMessage = null;
        StateHasChanged();

        try
        {
            var json = TimeService.ExportData();
            var filename = $"budgetr-export-{DateTime.Now:yyyy-MM-dd-HHmmss}.json";
            
            await JS.InvokeVoidAsync("syncInterop.downloadFile", filename, json);
            
            statusMessage = "Data exported successfully!";
            statusClass = "success";
        }
        catch (Exception ex)
        {
            statusMessage = $"Export failed: {ex.Message}";
            statusClass = "error";
        }
        finally
        {
            isExporting = false;
            StateHasChanged();
        }
    }

    private void OnFileSelected(ChangeEventArgs e)
    {
        selectedFileName = e.Value?.ToString();
        statusMessage = null;
        StateHasChanged();
    }

    private async Task ImportData()
    {
        isImporting = true;
        statusMessage = null;
        StateHasChanged();

        try
        {
            var content = await JS.InvokeAsync<string>("syncInterop.readFileContent", fileInput);
            await TimeService.ImportDataAsync(content);
            
            statusMessage = "Data imported successfully! Meters and events have been updated.";
            statusClass = "success";
            selectedFileName = null;
        }
        catch (Exception ex)
        {
            statusMessage = $"Import failed: {ex.Message}";
            statusClass = "error";
        }
        finally
        {
            isImporting = false;
            StateHasChanged();
        }
    }
}
