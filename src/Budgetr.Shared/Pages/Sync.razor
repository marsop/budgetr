@page "/sync"
@using Budgetr.Shared.Services
@using Microsoft.JSInterop
@inject ITimeTrackingService TimeService
@inject IJSRuntime JS
@inject IAutoSyncService AutoSyncService
@implements IDisposable

<div class="sync-page">
    <h2 class="page-title">Sync</h2>
    
    <div class="sync-tabs">
        <button class="tab-button @(activeTab == "local" ? "active" : "")" @onclick="@(() => activeTab = "local")">
            <span class="tab-icon">üìÅ</span>
            <span>Local</span>
        </button>
        <button class="tab-button @(activeTab == "gdrive" ? "active" : "")" @onclick="@(() => SwitchToGoogleDrive())">
            <span class="tab-icon">‚òÅÔ∏è</span>
            <span>Google Drive</span>
        </button>
    </div>
    
    @if (activeTab == "local")
    {
        <div class="sync-section">
            <h3>Export Data</h3>
            <p class="section-description">Download all your data (meters and events) as a JSON file.</p>
            <button class="sync-button export-btn" @onclick="ExportData" disabled="@isExporting">
                <span class="btn-icon">üì•</span>
                <span>@(isExporting ? "Exporting..." : "Export Data")</span>
            </button>
        </div>
        
        <div class="sync-section">
            <h3>Import Data</h3>
            <p class="section-description">Replace your current data by importing a JSON file.</p>
            
            <div class="file-input-container">
                <input type="file" 
                       id="importFileInput" 
                       accept=".json" 
                       @ref="fileInput" 
                       @onchange="OnFileSelected"
                       class="file-input" />
                <label for="importFileInput" class="file-label">
                    <span class="btn-icon">üìÅ</span>
                    <span>Choose File</span>
                </label>
            </div>
            
            @if (!string.IsNullOrEmpty(selectedFileName))
            {
                <div class="selected-file">
                    <span>Selected: @selectedFileName</span>
                </div>
                <button class="sync-button import-btn" @onclick="ImportData" disabled="@isImporting">
                    <span class="btn-icon">üì§</span>
                    <span>@(isImporting ? "Importing..." : "Import Data")</span>
                </button>
            }
        </div>
    }
    else if (activeTab == "gdrive")
    {
        <div class="sync-section">
            <h3>‚òÅÔ∏è Google Drive Sync</h3>
            <p class="section-description">Backup and restore your data using Google Drive.</p>
            
            @if (!isGoogleDriveConfigured)
            {
                <div class="config-section">
                    <p class="config-note">
                        To use Google Drive sync, you need to configure an OAuth Client ID from 
                        <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console</a>.
                    </p>
                    <div class="config-input-group">
                        <label for="clientIdInput">OAuth Client ID:</label>
                        <input type="text" 
                               id="clientIdInput" 
                               @bind="clientIdInput" 
                               placeholder="Enter your Client ID"
                               class="config-input" />
                    </div>
                    <button class="sync-button config-btn" @onclick="ConfigureGoogleDrive" disabled="@string.IsNullOrWhiteSpace(clientIdInput)">
                        <span class="btn-icon">‚öôÔ∏è</span>
                        <span>Configure</span>
                    </button>
                </div>
            }
            else if (!isGoogleDriveSignedIn)
            {
                <button class="sync-button google-btn" @onclick="SignInWithGoogle" disabled="@isSigningIn">
                    <span class="btn-icon">üîë</span>
                    <span>@(isSigningIn ? "Signing in..." : "Sign in with Google")</span>
                </button>
                
                <div class="reconfigure-section">
                    <button class="link-button" @onclick="ShowReconfigure">Reconfigure Client ID</button>
                </div>
            }
            else
            {
                <div class="signed-in-info">
                    <span class="check-icon">‚úÖ</span>
                    <span>Signed in as <strong>@googleUserEmail</strong></span>
                </div>
                
                @if (lastBackupTime.HasValue)
                {
                    <div class="backup-info">
                        <span class="info-icon">‚ÑπÔ∏è</span>
                        <span>Last backup: @lastBackupTime.Value.ToLocalTime().ToString("g")</span>
                    </div>
                }
                
                <div class="gdrive-actions">
                    <button class="sync-button backup-btn" @onclick="BackupToGoogleDrive" disabled="@isBackingUp">
                        <span class="btn-icon">‚¨ÜÔ∏è</span>
                        <span>@(isBackingUp ? "Backing up..." : "Backup to Drive")</span>
                    </button>
                    
                    <button class="sync-button restore-btn" @onclick="RestoreFromGoogleDrive" disabled="@isRestoring">
                        <span class="btn-icon">‚¨áÔ∏è</span>
                        <span>@(isRestoring ? "Restoring..." : "Restore from Drive")</span>
                    </button>
                </div>
                
                <div class="auto-sync-section">
                    <div class="auto-sync-header">
                        <span class="auto-sync-label">üîÑ Auto-sync on changes</span>
                        <label class="toggle-switch">
                            <input type="checkbox" checked="@isAutoSyncEnabled" @onchange="OnAutoSyncToggled" disabled="@isTogglingAutoSync" />
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    @if (isAutoSyncEnabled)
                    {
                        <div class="auto-sync-status @GetAutoSyncStatusClass()">
                            @switch (autoSyncStatus)
                            {
                                case AutoSyncStatus.Syncing:
                                    <span class="status-icon spinning">üîÑ</span>
                                    <span>Syncing...</span>
                                    break;
                                case AutoSyncStatus.Success:
                                    <span class="status-icon">‚úÖ</span>
                                    <span>Last auto-sync: @(lastAutoSyncTime?.ToLocalTime().ToString("g") ?? "Never")</span>
                                    break;
                                case AutoSyncStatus.Failed:
                                    <span class="status-icon">‚ùå</span>
                                    <span>Sync failed - will retry on next change</span>
                                    break;
                                default:
                                    <span class="status-icon">‚è≥</span>
                                    <span>Watching for changes...</span>
                                    break;
                            }
                        </div>
                    }
                </div>
                
                <div class="signout-section">
                    <button class="link-button signout" @onclick="SignOutFromGoogle">Sign Out</button>
                </div>
            }
        </div>
    }
    
    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <div class="status-message @statusClass">
            @statusMessage
        </div>
    }
    
    <Budgetr.Shared.Components.ConfirmationDialog 
        IsVisible="@showConfirmation1" 
        Title="Factory Reset" 
        Message="Are you sure you want to reset the application? This will effectively delete ALL your data and cannot be undone." 
        OnClose="OnConfirm1" />
        
    <Budgetr.Shared.Components.ConfirmationDialog 
        IsVisible="@showConfirmation2" 
        Title="FINAL WARNING" 
        Message="I am serious. This will wipe all meters, history, and settings. Are you absolutely sure?" 
        OnClose="OnConfirm2" />

    <div class="sync-section danger-zone">
        <h3>Factory Reset</h3>
        <p class="section-description">Reset the application to its initial state. Deletes all data.</p>
        <button class="sync-button reset-btn" @onclick="RequestReset">
            <span class="btn-icon">‚ö†Ô∏è</span>
            <span>Reset Application</span>
        </button>
    </div>
</div>

@code {
    private ElementReference fileInput;
    private string? selectedFileName;
    private bool isExporting;
    private bool isImporting;
    private string? statusMessage;
    private string statusClass = "";
    
    // Tab state
    private string activeTab = "local";
    
    // Google Drive state
    private bool isGoogleDriveConfigured;
    private bool isGoogleDriveSignedIn;
    private string? googleUserEmail;
    private string? clientIdInput;
    private bool isSigningIn;
    private bool isBackingUp;
    private bool isRestoring;
    private DateTimeOffset? lastBackupTime;
    
    // Auto-sync state
    private bool isAutoSyncEnabled;
    private bool isTogglingAutoSync;
    private AutoSyncStatus autoSyncStatus = AutoSyncStatus.Idle;
    private DateTimeOffset? lastAutoSyncTime;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Subscribe to auto-sync status changes
            AutoSyncService.OnStatusChanged += OnAutoSyncStatusChanged;
            
            // Try to auto-initialize Google Drive if previously configured
            await TryInitializeGoogleDrive();
        }
    }

    private async Task TryInitializeGoogleDrive()
    {
        try
        {
            var savedClientId = await JS.InvokeAsync<string?>("localStorage.getItem", "budgetr_gdrive_clientid");
            if (!string.IsNullOrEmpty(savedClientId))
            {
                await JS.InvokeVoidAsync("googleDriveInterop.initialize", savedClientId);
                isGoogleDriveConfigured = true;
                isGoogleDriveSignedIn = await JS.InvokeAsync<bool>("googleDriveInterop.isSignedIn");
                
                if (isGoogleDriveSignedIn)
                {
                    googleUserEmail = await JS.InvokeAsync<string?>("googleDriveInterop.getUserEmail");
                    await RefreshBackupInfo();
                    await RefreshAutoSyncState();
                }
                
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to auto-initialize Google Drive: {ex.Message}");
        }
    }

    private async Task SwitchToGoogleDrive()
    {
        activeTab = "gdrive";
        statusMessage = null;
        
        if (isGoogleDriveConfigured && isGoogleDriveSignedIn)
        {
            await RefreshBackupInfo();
        }
    }

    private async Task ConfigureGoogleDrive()
    {
        if (string.IsNullOrWhiteSpace(clientIdInput))
            return;
            
        statusMessage = null;
        
        try
        {
            await JS.InvokeVoidAsync("localStorage.setItem", "budgetr_gdrive_clientid", clientIdInput);
            await JS.InvokeVoidAsync("googleDriveInterop.initialize", clientIdInput);
            isGoogleDriveConfigured = true;
            statusMessage = "Google Drive configured successfully!";
            statusClass = "success";
        }
        catch (Exception ex)
        {
            statusMessage = $"Configuration failed: {ex.Message}";
            statusClass = "error";
        }
    }

    private void ShowReconfigure()
    {
        isGoogleDriveConfigured = false;
        clientIdInput = null;
        statusMessage = null;
    }

    private async Task SignInWithGoogle()
    {
        isSigningIn = true;
        statusMessage = null;
        StateHasChanged();
        
        try
        {
            var success = await JS.InvokeAsync<bool>("googleDriveInterop.signIn");
            if (success)
            {
                isGoogleDriveSignedIn = true;
                googleUserEmail = await JS.InvokeAsync<string?>("googleDriveInterop.getUserEmail");
                await RefreshBackupInfo();
                statusMessage = "Signed in successfully!";
                statusClass = "success";
            }
            else
            {
                statusMessage = "Sign in was cancelled.";
                statusClass = "error";
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Sign in failed: {ex.Message}";
            statusClass = "error";
        }
        finally
        {
            isSigningIn = false;
            StateHasChanged();
        }
    }

    private async Task SignOutFromGoogle()
    {
        try
        {
            await JS.InvokeVoidAsync("googleDriveInterop.signOut");
            isGoogleDriveSignedIn = false;
            googleUserEmail = null;
            lastBackupTime = null;
            
            // Disable auto-sync when signing out
            if (isAutoSyncEnabled)
            {
                await AutoSyncService.DisableAsync();
                isAutoSyncEnabled = false;
            }
            
            statusMessage = "Signed out successfully.";
            statusClass = "success";
        }
        catch (Exception ex)
        {
            statusMessage = $"Sign out failed: {ex.Message}";
            statusClass = "error";
        }
        StateHasChanged();
    }

    private async Task RefreshBackupInfo()
    {
        try
        {
            var lastModified = await JS.InvokeAsync<string?>("googleDriveInterop.getBackupLastModified");
            if (!string.IsNullOrEmpty(lastModified) && DateTimeOffset.TryParse(lastModified, out var parsed))
            {
                lastBackupTime = parsed;
            }
            else
            {
                lastBackupTime = null;
            }
        }
        catch
        {
            lastBackupTime = null;
        }
    }

    private async Task BackupToGoogleDrive()
    {
        isBackingUp = true;
        statusMessage = null;
        StateHasChanged();
        
        try
        {
            var json = TimeService.ExportData();
            await JS.InvokeVoidAsync("googleDriveInterop.saveBackup", json);
            await RefreshBackupInfo();
            statusMessage = "Backup completed successfully!";
            statusClass = "success";
        }
        catch (Exception ex)
        {
            statusMessage = $"Backup failed: {ex.Message}";
            statusClass = "error";
        }
        finally
        {
            isBackingUp = false;
            StateHasChanged();
        }
    }

    private async Task RestoreFromGoogleDrive()
    {
        isRestoring = true;
        statusMessage = null;
        StateHasChanged();
        
        try
        {
            var content = await JS.InvokeAsync<string?>("googleDriveInterop.getLatestBackup");
            
            if (string.IsNullOrEmpty(content))
            {
                statusMessage = "No backup found in Google Drive.";
                statusClass = "error";
            }
            else
            {
                await TimeService.ImportDataAsync(content);
                statusMessage = "Data restored successfully from Google Drive!";
                statusClass = "success";
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Restore failed: {ex.Message}";
            statusClass = "error";
        }
        finally
        {
            isRestoring = false;
            StateHasChanged();
        }
    }

    private async Task ExportData()
    {
        isExporting = true;
        statusMessage = null;
        StateHasChanged();

        try
        {
            var json = TimeService.ExportData();
            var filename = $"budgetr-export-{DateTime.Now:yyyy-MM-dd-HHmmss}.json";
            
            await JS.InvokeVoidAsync("syncInterop.downloadFile", filename, json);
            
            statusMessage = "Data exported successfully!";
            statusClass = "success";
        }
        catch (Exception ex)
        {
            statusMessage = $"Export failed: {ex.Message}";
            statusClass = "error";
        }
        finally
        {
            isExporting = false;
            StateHasChanged();
        }
    }

    private void OnFileSelected(ChangeEventArgs e)
    {
        selectedFileName = e.Value?.ToString();
        statusMessage = null;
        StateHasChanged();
    }

    private async Task ImportData()
    {
        isImporting = true;
        statusMessage = null;
        StateHasChanged();

        try
        {
            var content = await JS.InvokeAsync<string>("syncInterop.readFileContent", fileInput);
            await TimeService.ImportDataAsync(content);
            
            statusMessage = "Data imported successfully! Meters and events have been updated.";
            statusClass = "success";
            selectedFileName = null;
        }
        catch (Exception ex)
        {
            statusMessage = $"Import failed: {ex.Message}";
            statusClass = "error";
        }
        finally
        {
            isImporting = false;
            StateHasChanged();
        }
    }

    // Auto-sync methods
    private async Task OnAutoSyncToggled(ChangeEventArgs e)
    {
        var newValue = (bool)(e.Value ?? false);
        isTogglingAutoSync = true;
        StateHasChanged();
        
        try
        {
            if (newValue)
            {
                await AutoSyncService.EnableAsync();
                isAutoSyncEnabled = true;
                statusMessage = "Auto-sync enabled. Changes will be backed up automatically.";
                statusClass = "success";
            }
            else
            {
                await AutoSyncService.DisableAsync();
                isAutoSyncEnabled = false;
                statusMessage = "Auto-sync disabled.";
                statusClass = "success";
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Failed to toggle auto-sync: {ex.Message}";
            statusClass = "error";
        }
        finally
        {
            isTogglingAutoSync = false;
            StateHasChanged();
        }
    }

    private void OnAutoSyncStatusChanged(AutoSyncStatus status)
    {
        autoSyncStatus = status;
        lastAutoSyncTime = AutoSyncService.LastSyncTime;
        InvokeAsync(StateHasChanged);
    }

    private async Task RefreshAutoSyncState()
    {
        isAutoSyncEnabled = AutoSyncService.IsEnabled;
        autoSyncStatus = AutoSyncService.Status;
        lastAutoSyncTime = AutoSyncService.LastSyncTime;
    }

    private string GetAutoSyncStatusClass()
    {
        return autoSyncStatus switch
        {
            AutoSyncStatus.Syncing => "syncing",
            AutoSyncStatus.Success => "success",
            AutoSyncStatus.Failed => "error",
            _ => "idle"
        };
    }

    public void Dispose()
    {
        AutoSyncService.OnStatusChanged -= OnAutoSyncStatusChanged;
    }

    // Reset Logic
    private bool showConfirmation1;
    private bool showConfirmation2;

    [Inject] private ITutorialService TutorialService { get; set; } = default!;
    [Inject] private NavigationManager NavigationManager { get; set; } = default!;

    private void RequestReset()
    {
        showConfirmation1 = true;
        StateHasChanged();
    }

    private void OnConfirm1(bool confirmed)
    {
        showConfirmation1 = false;
        if (confirmed)
        {
            showConfirmation2 = true;
        }
        StateHasChanged();
    }

    private async Task OnConfirm2(bool confirmed)
    {
        showConfirmation2 = false;
        if (confirmed)
        {
            await PerformReset();
        }
        StateHasChanged();
    }

    private async Task PerformReset()
    {
        try 
        {
            // 1. Reset Time/Meter Data
            await TimeService.ResetDataAsync();
            
            // 2. Reset Tutorial
            await TutorialService.ResetTutorialAsync();
            
            // 3. Navigate to Home to start fresh (and trigger tutorial)
            NavigationManager.NavigateTo("", forceLoad: true);
        }
        catch (Exception ex)
        {
             statusMessage = $"Reset failed: {ex.Message}";
             statusClass = "error";
        }
    }
}
