@page "/sync"
@using Budgetr.Shared.Services
@using Microsoft.JSInterop
@inject ITimeTrackingService TimeService
@inject IJSRuntime JS
@inject IAutoSyncService AutoSyncService
@inject IStringLocalizer<Strings> Localizer
@using Budgetr.Shared.Resources
@implements IDisposable

<div class="sync-page">
    <h2 class="page-title">@Localizer["NavSync"]</h2>
    
    <div class="sync-tabs">
        <button class="tab-button @(activeTab == "local" ? "active" : "")" @onclick="@(() => activeTab = "local")">
            <span class="tab-icon">üìÅ</span>
            <span>@Localizer["TabLocal"]</span>
        </button>
        <button class="tab-button @(activeTab == "gdrive" ? "active" : "")" @onclick="@(() => SwitchToGoogleDrive())">
            <span class="tab-icon">‚òÅÔ∏è</span>
            <span>@Localizer["TabGDrive"]</span>
        </button>
    </div>
    
    @if (activeTab == "local")
    {
        <div class="sync-section">
            <h3>@Localizer["ExportData"]</h3>
            <p class="section-description">@Localizer["ExportDesc"]</p>
            <button class="sync-button export-btn" @onclick="ExportData" disabled="@isExporting">
                <span class="btn-icon">üì•</span>
                <span>@(isExporting ? Localizer["Exporting"] : Localizer["ExportData"])</span>
            </button>
        </div>
        
        <div class="sync-section">
            <h3>@Localizer["ImportData"]</h3>
            <p class="section-description">@Localizer["ImportDesc"]</p>
            
            <div class="file-input-container">
                <input type="file" 
                       id="importFileInput" 
                       accept=".json" 
                       @ref="fileInput" 
                       @onchange="OnFileSelected"
                       class="file-input" />
                <label for="importFileInput" class="file-label">
                    <span class="btn-icon">üìÅ</span>
                    <span>@Localizer["ChooseFile"]</span>
                </label>
            </div>
            
            @if (!string.IsNullOrEmpty(selectedFileName))
            {
                <div class="selected-file">
                    <span>@Localizer["SelectedFile", selectedFileName]</span>
                </div>
                <button class="sync-button import-btn" @onclick="ImportData" disabled="@isImporting">
                    <span class="btn-icon">üì§</span>
                    <span>@(isImporting ? Localizer["Importing"] : Localizer["ImportData"])</span>
                </button>
            }
        </div>
    }
    else if (activeTab == "gdrive")
    {
        <div class="sync-section">
            <h3>‚òÅÔ∏è @Localizer["GDriveSync"]</h3>
            <p class="section-description">@Localizer["GDriveDesc"]</p>
            
            @if (!isGoogleDriveConfigured)
            {
                <div class="config-section">
                    <p class="config-note">
                        @Localizer["GDriveConfigNote"]
                    </p>
                    <div class="config-input-group">
                        <label for="clientIdInput">@Localizer["OAuthClientId"]</label>
                        <input type="text" 
                               id="clientIdInput" 
                               @bind="clientIdInput" 
                               placeholder="@Localizer["EnterClientId"]"
                               class="config-input" />
                    </div>
                    <button class="sync-button config-btn" @onclick="ConfigureGoogleDrive" disabled="@string.IsNullOrWhiteSpace(clientIdInput)">
                        <span class="btn-icon">‚öôÔ∏è</span>
                        <span>@Localizer["Configure"]</span>
                    </button>
                </div>
            }
            else if (!isGoogleDriveSignedIn)
            {
                <button class="sync-button google-btn" @onclick="SignInWithGoogle" disabled="@isSigningIn">
                    <span class="btn-icon">üîë</span>
                    <span>@(isSigningIn ? Localizer["SigningIn"] : Localizer["SignInWithGoogle"])</span>
                </button>
                
                <div class="reconfigure-section">
                    <button class="link-button" @onclick="ShowReconfigure">@Localizer["ReconfigureClientId"]</button>
                </div>
            }
            else
            {
                <div class="signed-in-info">
                    <span class="check-icon">‚úÖ</span>
                    <span>@Localizer["SignedInAs", googleUserEmail ?? ""]</span>
                </div>
                
                @if (lastBackupTime.HasValue)
                {
                    <div class="backup-info">
                        <span class="info-icon">‚ÑπÔ∏è</span>
                        <span>@Localizer["LastBackup", lastBackupTime.Value.ToLocalTime().ToString("g")]</span>
                    </div>
                }
                
                <div class="gdrive-actions">
                    <button class="sync-button backup-btn" @onclick="BackupToGoogleDrive" disabled="@isBackingUp">
                        <span class="btn-icon">‚¨ÜÔ∏è</span>
                        <span>@(isBackingUp ? Localizer["BackingUp"] : Localizer["BackupToDrive"])</span>
                    </button>
                    
                    <button class="sync-button restore-btn" @onclick="RestoreFromGoogleDrive" disabled="@isRestoring">
                        <span class="btn-icon">‚¨áÔ∏è</span>
                        <span>@(isRestoring ? Localizer["Restoring"] : Localizer["RestoreFromDrive"])</span>
                    </button>
                </div>
                
                <div class="auto-sync-section">
                    <div class="auto-sync-header">
                        <span class="auto-sync-label">üîÑ @Localizer["AutoSync"]</span>
                        <label class="toggle-switch">
                            <input type="checkbox" checked="@isAutoSyncEnabled" @onchange="OnAutoSyncToggled" disabled="@isTogglingAutoSync" />
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    @if (isAutoSyncEnabled)
                    {
                        <div class="auto-sync-status @GetAutoSyncStatusClass()">
                            @switch (autoSyncStatus)
                            {
                                case AutoSyncStatus.Syncing:
                                    <span class="status-icon spinning">üîÑ</span>
                                    <span>@Localizer["Syncing"]</span>
                                    break;
                                case AutoSyncStatus.Success:
                                    <span class="status-icon">‚úÖ</span>
                                    <span>@Localizer["LastAutoSync", lastAutoSyncTime?.ToLocalTime().ToString("g") ?? "Never"]</span>
                                    break;
                                case AutoSyncStatus.Failed:
                                    <span class="status-icon">‚ùå</span>
                                    <span>@Localizer["SyncFailedRetry"]</span>
                                    break;
                                default:
                                    <span class="status-icon">‚è≥</span>
                                    <span>@Localizer["WatchingChanges"]</span>
                                    break;
                            }
                        </div>
                    }
                </div>
                
                <div class="signout-section">
                    <button class="link-button signout" @onclick="SignOutFromGoogle">@Localizer["SignOut"]</button>
                </div>
            }
        </div>
    }
    
    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <div class="status-message @statusClass">
            @statusMessage
        </div>
    }
    

</div>

@code {
    private ElementReference fileInput;
    private string? selectedFileName;
    private bool isExporting;
    private bool isImporting;
    private string? statusMessage;
    private string statusClass = "";
    
    // Tab state
    private string activeTab = "local";
    
    // Google Drive state
    private bool isGoogleDriveConfigured;
    private bool isGoogleDriveSignedIn;
    private string? googleUserEmail;
    private string? clientIdInput;
    private bool isSigningIn;
    private bool isBackingUp;
    private bool isRestoring;
    private DateTimeOffset? lastBackupTime;
    
    // Auto-sync state
    private bool isAutoSyncEnabled;
    private bool isTogglingAutoSync;
    private AutoSyncStatus autoSyncStatus = AutoSyncStatus.Idle;
    private DateTimeOffset? lastAutoSyncTime;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Subscribe to auto-sync status changes
            AutoSyncService.OnStatusChanged += OnAutoSyncStatusChanged;
            
            // Try to auto-initialize Google Drive if previously configured
            await TryInitializeGoogleDrive();
        }
    }

    private async Task TryInitializeGoogleDrive()
    {
        try
        {
            var savedClientId = await JS.InvokeAsync<string?>("localStorage.getItem", "budgetr_gdrive_clientid");
            if (!string.IsNullOrEmpty(savedClientId))
            {
                await JS.InvokeVoidAsync("googleDriveInterop.initialize", savedClientId);
                isGoogleDriveConfigured = true;
                isGoogleDriveSignedIn = await JS.InvokeAsync<bool>("googleDriveInterop.isSignedIn");
                
                if (isGoogleDriveSignedIn)
                {
                    googleUserEmail = await JS.InvokeAsync<string?>("googleDriveInterop.getUserEmail");
                    await RefreshBackupInfo();
                    RefreshAutoSyncState();
                }
                
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to auto-initialize Google Drive: {ex.Message}");
        }
    }

    private async Task SwitchToGoogleDrive()
    {
        activeTab = "gdrive";
        statusMessage = null;
        
        if (isGoogleDriveConfigured && isGoogleDriveSignedIn)
        {
            await RefreshBackupInfo();
        }
    }

    private async Task ConfigureGoogleDrive()
    {
        if (string.IsNullOrWhiteSpace(clientIdInput))
            return;
            
        statusMessage = null;
        
        try
        {
            await JS.InvokeVoidAsync("localStorage.setItem", "budgetr_gdrive_clientid", clientIdInput);
            await JS.InvokeVoidAsync("googleDriveInterop.initialize", clientIdInput);
            isGoogleDriveConfigured = true;
            statusMessage = Localizer["SuccessGDriveConfig"];
            statusClass = "success";
        }
        catch (Exception ex)
        {
            statusMessage = Localizer["ErrorConfigFailed", ex.Message];
            statusClass = "error";
        }
    }

    private void ShowReconfigure()
    {
        isGoogleDriveConfigured = false;
        clientIdInput = null;
        statusMessage = null;
    }

    private async Task SignInWithGoogle()
    {
        isSigningIn = true;
        statusMessage = null;
        StateHasChanged();
        
        try
        {
            var success = await JS.InvokeAsync<bool>("googleDriveInterop.signIn");
            if (success)
            {
                isGoogleDriveSignedIn = true;
                googleUserEmail = await JS.InvokeAsync<string?>("googleDriveInterop.getUserEmail");
                await RefreshBackupInfo();
                statusMessage = Localizer["SuccessSignIn"];
                statusClass = "success";
            }
            else
            {
                statusMessage = Localizer["ErrorSignInCancelled"];
                statusClass = "error";
            }
        }
        catch (Exception ex)
        {
            statusMessage = Localizer["ErrorSignInFailed", ex.Message];
            statusClass = "error";
        }
        finally
        {
            isSigningIn = false;
            StateHasChanged();
        }
    }

    private async Task SignOutFromGoogle()
    {
        try
        {
            await JS.InvokeVoidAsync("googleDriveInterop.signOut");
            isGoogleDriveSignedIn = false;
            googleUserEmail = null;
            lastBackupTime = null;
            
            // Disable auto-sync when signing out
            if (isAutoSyncEnabled)
            {
                await AutoSyncService.DisableAsync();
                isAutoSyncEnabled = false;
            }
            
            statusMessage = Localizer["SuccessSignOut"];
            statusClass = "success";
        }
        catch (Exception ex)
        {
            statusMessage = Localizer["ErrorSignOutFailed", ex.Message];
            statusClass = "error";
        }
        StateHasChanged();
    }

    private async Task RefreshBackupInfo()
    {
        try
        {
            var lastModified = await JS.InvokeAsync<string?>("googleDriveInterop.getBackupLastModified");
            if (!string.IsNullOrEmpty(lastModified) && DateTimeOffset.TryParse(lastModified, out var parsed))
            {
                lastBackupTime = parsed;
            }
            else
            {
                lastBackupTime = null;
            }
        }
        catch
        {
            lastBackupTime = null;
        }
    }

    private async Task BackupToGoogleDrive()
    {
        isBackingUp = true;
        statusMessage = null;
        StateHasChanged();
        
        try
        {
            var json = TimeService.ExportData();
            await JS.InvokeVoidAsync("googleDriveInterop.saveBackup", json);
            await RefreshBackupInfo();
            statusMessage = Localizer["SuccessBackup"];
            statusClass = "success";
        }
        catch (Exception ex)
        {
            statusMessage = Localizer["ErrorBackupFailed", ex.Message];
            statusClass = "error";
        }
        finally
        {
            isBackingUp = false;
            StateHasChanged();
        }
    }

    private async Task RestoreFromGoogleDrive()
    {
        isRestoring = true;
        statusMessage = null;
        StateHasChanged();
        
        try
        {
            var content = await JS.InvokeAsync<string?>("googleDriveInterop.getLatestBackup");
            
            if (string.IsNullOrEmpty(content))
            {
                statusMessage = Localizer["ErrorNoBackup"];
                statusClass = "error";
            }
            else
            {
                await TimeService.ImportDataAsync(content);
                statusMessage = Localizer["SuccessRestore"];
                statusClass = "success";
            }
        }
        catch (Exception ex)
        {
            statusMessage = Localizer["ErrorRestoreFailed", ex.Message];
            statusClass = "error";
        }
        finally
        {
            isRestoring = false;
            StateHasChanged();
        }
    }

    private async Task ExportData()
    {
        isExporting = true;
        statusMessage = null;
        StateHasChanged();

        try
        {
            var json = TimeService.ExportData();
            var filename = $"budgetr-export-{DateTime.Now:yyyy-MM-dd-HHmmss}.json";
            
            await JS.InvokeVoidAsync("syncInterop.downloadFile", filename, json);
            
            statusMessage = Localizer["SuccessExport"];
            statusClass = "success";
        }
        catch (Exception ex)
        {
            statusMessage = Localizer["ErrorExportFailed", ex.Message];
            statusClass = "error";
        }
        finally
        {
            isExporting = false;
            StateHasChanged();
        }
    }

    private void OnFileSelected(ChangeEventArgs e)
    {
        selectedFileName = e.Value?.ToString();
        statusMessage = null;
        StateHasChanged();
    }

    private async Task ImportData()
    {
        isImporting = true;
        statusMessage = null;
        StateHasChanged();

        try
        {
            var content = await JS.InvokeAsync<string>("syncInterop.readFileContent", fileInput);
            await TimeService.ImportDataAsync(content);
            
            statusMessage = Localizer["SuccessImport"];
            statusClass = "success";
            selectedFileName = null;
        }
        catch (Exception ex)
        {
            statusMessage = Localizer["ErrorImportFailed", ex.Message];
            statusClass = "error";
        }
        finally
        {
            isImporting = false;
            StateHasChanged();
        }
    }

    // Auto-sync methods
    private async Task OnAutoSyncToggled(ChangeEventArgs e)
    {
        var newValue = (bool)(e.Value ?? false);
        isTogglingAutoSync = true;
        StateHasChanged();
        
        try
        {
            if (newValue)
            {
                await AutoSyncService.EnableAsync();
                isAutoSyncEnabled = true;
                statusMessage = Localizer["SuccessAutoSyncEnabled"];
                statusClass = "success";
            }
            else
            {
                await AutoSyncService.DisableAsync();
                isAutoSyncEnabled = false;
                statusMessage = Localizer["SuccessAutoSyncDisabled"];
                statusClass = "success";
            }
        }
        catch (Exception ex)
        {
            statusMessage = Localizer["ErrorToggleAutoSync", ex.Message];
            statusClass = "error";
        }
        finally
        {
            isTogglingAutoSync = false;
            StateHasChanged();
        }
    }

    private void OnAutoSyncStatusChanged(AutoSyncStatus status)
    {
        autoSyncStatus = status;
        lastAutoSyncTime = AutoSyncService.LastSyncTime;
        InvokeAsync(StateHasChanged);
    }

    private void RefreshAutoSyncState()
    {
        isAutoSyncEnabled = AutoSyncService.IsEnabled;
        autoSyncStatus = AutoSyncService.Status;
        lastAutoSyncTime = AutoSyncService.LastSyncTime;
    }

    private string GetAutoSyncStatusClass()
    {
        return autoSyncStatus switch
        {
            AutoSyncStatus.Syncing => "syncing",
            AutoSyncStatus.Success => "success",
            AutoSyncStatus.Failed => "error",
            _ => "idle"
        };
    }

    public void Dispose()
    {
        AutoSyncService.OnStatusChanged -= OnAutoSyncStatusChanged;
    }


}
