@page "/meters"
@using Budgetr.Shared.Models
@using Budgetr.Shared.Services
@inject ITimeTrackingService TimeService
@implements IDisposable

<div class="meters-page">
    <h2 class="page-title">Meters</h2>
    
    <div class="meters-grid">
        @foreach (var meter in TimeService.Account.Meters.OrderBy(m => m.DisplayOrder))
        {
            var isActive = IsActiveMeter(meter.Id);
            var isEditing = _editingMeterId == meter.Id;
            
            <div class="meter-container">
                @if (isEditing)
                {
                    <div class="meter-edit-form">
                        <input type="text" 
                               class="meter-name-input @(_validationError != null ? "invalid" : "")"
                               @bind="_editingMeterName"
                               @bind:event="oninput"
                               @onkeydown="HandleEditKeyDown"
                               @onblur="SaveEdit"
                               maxlength="40"
                               autofocus />
                        <div class="edit-actions">
                            <button class="edit-action-btn save" @onclick="SaveEdit" title="Save">‚úì</button>
                            <button class="edit-action-btn cancel" @onclick="CancelEdit" @onclick:stopPropagation="true" title="Cancel">‚úï</button>
                        </div>
                        @if (_validationError != null)
                        {
                            <div class="validation-error">@_validationError</div>
                        }
                        <div class="char-count @(_editingMeterName?.Length > 40 ? "over-limit" : "")">
                            @(_editingMeterName?.Length ?? 0)/40
                        </div>
                    </div>
                }
                else
                {
                    <button class="meter-button @(isActive ? "active" : "") @(meter.Factor >= 0 ? "positive" : "negative")"
                            @onclick="() => ToggleMeter(meter.Id)">
                        <div class="meter-name">@meter.Name</div>
                        <div class="meter-factor">Factor: @meter.Factor.ToString("0.##")</div>
                        <div class="meter-status">
                            @if (isActive)
                            {
                                <span class="pulse"></span>
                                <span>Running</span>
                            }
                            else
                            {
                                <span>Tap to start</span>
                            }
                        </div>
                    </button>
                    <div class="meter-actions">
                        <button class="meter-action-btn" @onclick="() => StartEditing(meter)" @onclick:stopPropagation="true" title="Rename meter">
                            ‚úèÔ∏è
                        </button>
                        @if (!isActive)
                        {
                            <button class="meter-action-btn delete" @onclick="() => DeleteMeter(meter)" @onclick:stopPropagation="true" title="Delete meter">
                                üóëÔ∏è
                            </button>
                        }
                    </div>
                }
            </div>

        }
        
        <div class="meter-container add-meter">
            @if (_isAddingMeter)
            {
                <div class="meter-edit-form">
                    <input type="text" 
                           class="meter-name-input"
                           placeholder="Name"
                           @bind="_newMeterName"
                           maxlength="40"
                           autofocus />
                           
                    <input type="number" 
                           class="meter-factor-input"
                           placeholder="Factor (e.g. 1.0)"
                           step="0.1"
                           min="-10"
                           max="10"
                           @bind="_newMeterFactor" />
                           
                    <div class="edit-actions">
                        <button class="edit-action-btn save" @onclick="SaveNewMeter" title="Add">‚úì</button>
                        <button class="edit-action-btn cancel" @onclick="CancelAdd" title="Cancel">‚úï</button>
                    </div>
                    
                    @if (_addValidationError != null)
                    {
                        <div class="validation-error">@_addValidationError</div>
                    }
                </div>
            }
            else
            {
                <button class="meter-button add-meter-btn" @onclick="StartAdding">
                    <div class="add-icon">+</div>
                    <div class="add-text">Add Meter</div>
                </button>
            }
        </div>
    </div>
    
    @if (ActiveEvent != null)
    {
        <div class="active-info">
            <div class="active-duration">
                <span class="label">Running for:</span>
                <span class="value">@FormatDuration(ActiveEvent.Duration)</span>
            </div>
        </div>
    }
</div>

@code {
    private MeterEvent? ActiveEvent => TimeService.GetActiveEvent();
    
    private System.Threading.Timer? _timer;
    private Guid? _editingMeterId;
    private string? _editingMeterName;
    private string? _validationError;

    // Add Meter State
    private bool _isAddingMeter;
    private string _newMeterName = string.Empty;
    private double _newMeterFactor = 1.0;
    private string? _addValidationError;

    protected override void OnInitialized()
    {
        TimeService.OnStateChanged += StateHasChanged;
        
        // Update every second to show running duration
        _timer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(StateHasChanged);
        }, null, TimeSpan.Zero, TimeSpan.FromSeconds(1));
    }

    private bool IsActiveMeter(Guid meterId)
    {
        var activeEvent = ActiveEvent;
        if (activeEvent == null) return false;
        
        var meter = TimeService.Account.Meters.FirstOrDefault(m => m.Id == meterId);
        return meter != null && activeEvent.MeterName == meter.Name;
    }

    private void ToggleMeter(Guid meterId)
    {
        if (IsActiveMeter(meterId))
        {
            TimeService.DeactivateMeter();
        }
        else
        {
            TimeService.ActivateMeter(meterId);
        }
    }

    private void StartEditing(Meter meter)
    {
        _editingMeterId = meter.Id;
        _editingMeterName = meter.Name;
        _validationError = null;
        // Cancel adding if active
        CancelAdd();
    }

    private void SaveEdit()
    {
        if (_editingMeterId == null || _editingMeterName == null)
        {
            CancelEdit();
            return;
        }

        var trimmedName = _editingMeterName.Trim();
        
        if (trimmedName.Length < 1 || trimmedName.Length > 40)
        {
            _validationError = "Name must be 1-40 characters";
            return;
        }

        try
        {
            TimeService.RenameMeter(_editingMeterId.Value, trimmedName);
            CancelEdit();
        }
        catch (ArgumentException ex)
        {
            _validationError = ex.Message;
        }
    }

    private void CancelEdit()
    {
        _editingMeterId = null;
        _editingMeterName = null;
        _validationError = null;
    }

    private void HandleEditKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            SaveEdit();
        }
        else if (e.Key == "Escape")
        {
            CancelEdit();
        }
    }

    private string FormatDuration(TimeSpan duration)
    {
        if (duration.TotalHours >= 1)
        {
            return $"{(int)duration.TotalHours}h {duration.Minutes:D2}m {duration.Seconds:D2}s";
        }
        return $"{duration.Minutes:D2}m {duration.Seconds:D2}s";
    }

    private void DeleteMeter(Meter meter)
    {
        if (IsActiveMeter(meter.Id)) return;
        TimeService.DeleteMeter(meter.Id);
    }
    
    // Add Meter Logic
    private void StartAdding()
    {
        _isAddingMeter = true;
        _newMeterName = string.Empty;
        _newMeterFactor = 1.0;
        _addValidationError = null;
        // Cancel editing if active
        CancelEdit();
    }

    private void CancelAdd()
    {
        _isAddingMeter = false;
        _newMeterName = string.Empty;
        _addValidationError = null;
    }

    private void SaveNewMeter()
    {
        if (string.IsNullOrWhiteSpace(_newMeterName))
        {
            _addValidationError = "Name is required";
            return;
        }
        
        try
        {
            TimeService.AddMeter(_newMeterName, _newMeterFactor);
            CancelAdd();
        }
        catch (Exception ex)
        {
            _addValidationError = ex.Message;
        }
    }

    public void Dispose()
    {
        TimeService.OnStateChanged -= StateHasChanged;
        _timer?.Dispose();
    }
}
