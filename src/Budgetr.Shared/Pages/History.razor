@page "/history"
@using Budgetr.Shared.Services
@using Budgetr.Shared.Models
@inject ITimeTrackingService TimeService
@implements IDisposable

<div class="history-page">
    <h1 class="page-title">History</h1>
    
    @if (!Events.Any())
    {
        <div class="empty-state">
            <span class="empty-icon">ðŸ“­</span>
            <p>No events recorded yet</p>
            <p class="empty-hint">Start a meter to begin tracking time</p>
        </div>
    }
    else
    {
        <div class="events-list">
            @foreach (var evt in Events)
            {
                <div class="event-card @(evt.Factor >= 0 ? "positive" : "negative") @(evt.IsActive ? "active" : "")">
                    <div class="event-header">
                        <span class="event-meter-name">@evt.MeterName</span>
                        <div class="event-header-actions">
                            @if (evt.IsActive)
                            {
                                <span class="event-badge active-badge">
                                    <span class="pulse"></span>
                                    Active
                                </span>
                            }
                            @if (!evt.IsActive)
                            {
                                <button class="delete-btn" @onclick="() => ConfirmDelete(evt)" title="Delete entry">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                        <line x1="10" y1="11" x2="10" y2="17"></line>
                                        <line x1="14" y1="11" x2="14" y2="17"></line>
                                    </svg>
                                </button>
                            }
                        </div>
                    </div>
                    
                    <div class="event-times">
                        <div class="event-time">
                            <span class="time-label">Started</span>
                            <span class="time-value">@FormatDateTime(evt.StartTime)</span>
                        </div>
                        @if (evt.EndTime.HasValue)
                        {
                            <div class="event-time">
                                <span class="time-label">Ended</span>
                                <span class="time-value">@FormatDateTime(evt.EndTime.Value)</span>
                            </div>
                        }
                    </div>
                    
                    <div class="event-stats">
                        <div class="event-stat">
                            <span class="stat-label">Duration</span>
                            <span class="stat-value">@FormatDuration(evt.Duration)</span>
                        </div>
                        <div class="event-stat">
                            <span class="stat-label">Contribution</span>
                            <span class="stat-value contribution @(evt.TimeContribution.TotalHours >= 0 ? "positive" : "negative")">
                                @FormatContribution(evt.TimeContribution)
                            </span>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@if (_eventToDelete != null)
{
    <div class="modal-overlay" @onclick="CancelDelete">
        <div class="modal-dialog" @onclick:stopPropagation="true">
            <h3>Delete Entry?</h3>
            <p>Are you sure you want to delete this <strong>@_eventToDelete.MeterName</strong> entry?</p>
            <p class="modal-contribution">This will remove <span class="@(_eventToDelete.TimeContribution.TotalHours >= 0 ? "positive" : "negative")">@FormatContribution(_eventToDelete.TimeContribution)</span> from your balance.</p>
            <div class="modal-actions">
                <button class="btn-cancel" @onclick="CancelDelete">Cancel</button>
                <button class="btn-delete" @onclick="DeleteEvent">Delete</button>
            </div>
        </div>
    </div>
}

@code {
    private IEnumerable<MeterEvent> Events => TimeService.Account.Events
        .OrderByDescending(e => e.StartTime);
    
    private System.Threading.Timer? _timer;
    private MeterEvent? _eventToDelete;

    protected override void OnInitialized()
    {
        TimeService.OnStateChanged += StateHasChanged;
        
        // Update every second when a meter is active
        _timer = new System.Threading.Timer(_ =>
        {
            if (TimeService.GetActiveEvent() != null)
            {
                InvokeAsync(StateHasChanged);
            }
        }, null, TimeSpan.Zero, TimeSpan.FromSeconds(1));
    }

    private string FormatDateTime(DateTimeOffset dateTime)
    {
        var local = dateTime.ToLocalTime();
        var now = DateTimeOffset.Now;
        
        if (local.Date == now.Date)
        {
            return $"Today at {local:HH:mm}";
        }
        else if (local.Date == now.Date.AddDays(-1))
        {
            return $"Yesterday at {local:HH:mm}";
        }
        else if (local.Year == now.Year)
        {
            return local.ToString("MMM d 'at' HH:mm");
        }
        else
        {
            return local.ToString("MMM d, yyyy 'at' HH:mm");
        }
    }

    private string FormatDuration(TimeSpan duration)
    {
        if (duration.TotalHours >= 1)
        {
            return $"{(int)duration.TotalHours}h {duration.Minutes}m";
        }
        else if (duration.TotalMinutes >= 1)
        {
            return $"{(int)duration.TotalMinutes}m {duration.Seconds}s";
        }
        else
        {
            return $"{(int)duration.TotalSeconds}s";
        }
    }

    private string FormatContribution(TimeSpan contribution)
    {
        var sign = contribution.TotalHours >= 0 ? "+" : "";
        var hours = contribution.TotalHours;
        
        if (Math.Abs(hours) >= 1)
        {
            return $"{sign}{hours:F2}h";
        }
        else
        {
            var minutes = contribution.TotalMinutes;
            return $"{sign}{minutes:F1}m";
        }
    }

    private void ConfirmDelete(MeterEvent evt)
    {
        _eventToDelete = evt;
    }

    private void CancelDelete()
    {
        _eventToDelete = null;
    }

    private void DeleteEvent()
    {
        if (_eventToDelete != null)
        {
            TimeService.DeleteEvent(_eventToDelete.Id);
            _eventToDelete = null;
        }
    }

    public void Dispose()
    {
        TimeService.OnStateChanged -= StateHasChanged;
        _timer?.Dispose();
    }
}
