@page "/settings"
@page "/sync"
@using Budgetr.Shared.Services
@using Microsoft.JSInterop
@using Microsoft.Extensions.Configuration
@inject ISettingsService SettingsService
@inject NavigationManager NavigationManager
@inject IStringLocalizer<Strings> Localizer
@inject ITimeTrackingService TimeService
@inject ITutorialService TutorialService
@inject IJSRuntime JSRuntime
@inject IConfiguration Configuration
@inject IAutoSyncService AutoSyncService
@implements IDisposable

<div class="settings-page">
    <h1 class="page-title">@Localizer["NavSettings"]</h1>
    
    <!-- General Settings Section -->
    <div class="settings-section">
        <h2 class="section-title">‚öôÔ∏è @Localizer["NavSettings"]</h2>
        <div class="setting-item">
            <span class="setting-label">@Localizer["DisplayLanguage"]</span>
            <div class="language-dropdown">
                <button type="button" class="dropdown-trigger" @onclick="ToggleDropdown">
                    <span class="flag-icon">@GetFlag(SelectedLanguage)</span>
                    <span>@GetLanguageName(SelectedLanguage)</span>
                </button>
                <div class="dropdown-menu @(isDropdownOpen ? "show" : "")">
                    @foreach (var lang in Languages)
                    {
                        <div class="dropdown-item @(SelectedLanguage == lang.Code ? "selected" : "")" 
                             @onclick="() => SelectLanguage(lang.Code)" 
                             @onclick:stopPropagation="true">
                            <span class="flag-icon">@lang.Flag</span>
                            <span>@lang.Name</span>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="setting-item">
            <span class="setting-label">@Localizer["TutorialAvatar"]</span>
            <div class="language-dropdown">
                <button type="button" class="dropdown-trigger" @onclick="ToggleAvatarDropdown">
                    <span>@SelectedAvatarName</span>
                </button>
                <div class="dropdown-menu @(isAvatarDropdownOpen ? "show" : "")">
                    @foreach (var avatar in TutorialService.AvailableAvatars)
                    {
                        <div class="dropdown-item @(TutorialService.CurrentAvatar.Id == avatar.Id ? "selected" : "")" 
                             @onclick="() => SelectAvatar(avatar.Id)" 
                             @onclick:stopPropagation="true">
                            <span>@avatar.Name</span>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Timeular Section -->
    <div class="settings-section">
        <h2 class="section-title">üßä Timeular</h2>
        <p class="setting-description">Connect your Timeular device from here. Functional mapping will be configured later.</p>

        @if (!string.IsNullOrWhiteSpace(timeularDeviceName))
        {
            <div class="timeular-device-info">
                <span class="info-icon">üì∂</span>
                <span>Selected device: @timeularDeviceName</span>
            </div>
        }

        <div class="timeular-actions">
            <button class="sync-button timeular-connect-btn" @onclick="ConnectTimeularDevice" disabled="@isConnectingTimeular">
                <span class="btn-icon">üîó</span>
                <span>@(isConnectingTimeular ? "Connecting..." : (isTimeularConnected ? "Reconnect Timeular" : "Connect Timeular"))</span>
            </button>

            @if (isTimeularConnected)
            {
                <button class="sync-button timeular-disconnect-btn" @onclick="DisconnectTimeularDevice">
                    <span class="btn-icon">üîå</span>
                    <span>Disconnect</span>
                </button>
            }
        </div>

        @if (!string.IsNullOrWhiteSpace(timeularStatusMessage))
        {
            <div class="status-message @timeularStatusClass">
                @timeularStatusMessage
            </div>
        }
    </div>

    <!-- Data Management Section -->
    <div class="settings-section">
        <h2 class="section-title">üì¶ Data Management</h2>
        
        <!-- Tab buttons for Local vs Google Drive -->
        <div class="sync-tabs">
            <button class="tab-button @(activeTab == "local" ? "active" : "")" @onclick="@(() => activeTab = "local")">
                <span class="tab-icon">üìÅ</span>
                <span>@Localizer["TabLocal"]</span>
            </button>
            <button class="tab-button @(activeTab == "gdrive" ? "active" : "")" @onclick="@(() => SwitchToGoogleDrive())">
                <span class="tab-icon">‚òÅÔ∏è</span>
                <span>@Localizer["TabGDrive"]</span>
            </button>
        </div>
        
        @if (activeTab == "local")
        {
            <div class="sync-section">
                <h3>@Localizer["ExportData"]</h3>
                <p class="section-description">@Localizer["ExportDesc"]</p>
                <button class="sync-button export-btn" @onclick="ExportData" disabled="@isExporting">
                    <span class="btn-icon">üì•</span>
                    <span>@(isExporting ? Localizer["Exporting"] : Localizer["ExportData"])</span>
                </button>
            </div>
            
            <div class="sync-section">
                <h3>@Localizer["ImportData"]</h3>
                <p class="section-description">@Localizer["ImportDesc"]</p>
                
                <div class="file-input-container">
                    <input type="file" 
                           id="importFileInput" 
                           accept=".json" 
                           @ref="fileInput" 
                           @onchange="OnFileSelected"
                           class="file-input" />
                    <label for="importFileInput" class="file-label">
                        <span class="btn-icon">üìÅ</span>
                        <span>@Localizer["ChooseFile"]</span>
                    </label>
                </div>
                
                @if (!string.IsNullOrEmpty(selectedFileName))
                {
                    <div class="selected-file">
                        <span>@Localizer["SelectedFile", selectedFileName]</span>
                    </div>
                    <button class="sync-button import-btn" @onclick="ImportData" disabled="@isImporting">
                        <span class="btn-icon">üì§</span>
                        <span>@(isImporting ? Localizer["Importing"] : Localizer["ImportData"])</span>
                    </button>
                }
            </div>
        }
        else if (activeTab == "gdrive")
        {
            <div class="sync-section">
                <h3>‚òÅÔ∏è @Localizer["GDriveSync"]</h3>
                <p class="section-description">@Localizer["GDriveDesc"]</p>
                
                @if (!isGoogleDriveConfigured)
                {
                    <div class="config-section">
                        @if (IsConfiguredViaFile)
                        {
                            <div class="config-message success">
                                <span class="icon">üîí</span>
                                <span>@Localizer["ClientIdConfiguredViaFile"]</span>
                            </div>
                        }
                        else
                        {
                            <p class="config-note">
                                @Localizer["GDriveConfigNote"]
                            </p>
                            <div class="config-input-group">
                                <label for="clientIdInput">@Localizer["OAuthClientId"]</label>
                                <input type="text" 
                                       id="clientIdInput" 
                                       @bind="clientIdInput" 
                                       placeholder="@Localizer["EnterClientId"]"
                                       class="config-input" />
                            </div>
                        }
                        <button class="sync-button config-btn" @onclick="ConfigureGoogleDrive" disabled="@(!IsConfiguredViaFile && string.IsNullOrWhiteSpace(clientIdInput))">
                            <span class="btn-icon">‚öôÔ∏è</span>
                            <span>@Localizer["Configure"]</span>
                        </button>
                    </div>
                }
                else if (!isGoogleDriveSignedIn)
                {
                    <button class="sync-button google-btn" @onclick="SignInWithGoogle" disabled="@isSigningIn">
                        <span class="btn-icon">üîë</span>
                        <span>@(isSigningIn ? Localizer["SigningIn"] : Localizer["SignInWithGoogle"])</span>
                    </button>
                    
                    <div class="reconfigure-section">
                        <button class="link-button" @onclick="ShowReconfigure">@Localizer["ReconfigureClientId"]</button>
                    </div>
                }
                else
                {
                    <div class="signed-in-info">
                        <span class="check-icon">‚úÖ</span>
                        <span>@Localizer["SignedInAs", googleUserEmail ?? ""]</span>
                    </div>
                    
                    @if (lastBackupTime.HasValue)
                    {
                        <div class="backup-info">
                            <span class="info-icon">‚ÑπÔ∏è</span>
                            <span>@Localizer["LastBackup", lastBackupTime.Value.ToLocalTime().ToString("g")]</span>
                        </div>
                    }
                    
                    <div class="gdrive-actions">
                        <button class="sync-button backup-btn" @onclick="BackupToGoogleDrive" disabled="@isBackingUp">
                            <span class="btn-icon">‚¨ÜÔ∏è</span>
                            <span>@(isBackingUp ? Localizer["BackingUp"] : Localizer["BackupToDrive"])</span>
                        </button>
                        
                        <button class="sync-button restore-btn" @onclick="RestoreFromGoogleDrive" disabled="@isRestoring">
                            <span class="btn-icon">‚¨áÔ∏è</span>
                            <span>@(isRestoring ? Localizer["Restoring"] : Localizer["RestoreFromDrive"])</span>
                        </button>
                    </div>
                    
                    <div class="auto-sync-section">
                        <div class="auto-sync-header">
                            <span class="auto-sync-label">üîÑ @Localizer["AutoSync"]</span>
                            <label class="toggle-switch">
                                <input type="checkbox" checked="@isAutoSyncEnabled" @onchange="OnAutoSyncToggled" disabled="@isTogglingAutoSync" />
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        @if (isAutoSyncEnabled)
                        {
                            <div class="auto-sync-status @GetAutoSyncStatusClass()">
                                @switch (autoSyncStatus)
                                {
                                    case AutoSyncStatus.Syncing:
                                        <span class="status-icon spinning">üîÑ</span>
                                        <span>@Localizer["Syncing"]</span>
                                        break;
                                    case AutoSyncStatus.Success:
                                        <span class="status-icon">‚úÖ</span>
                                        <span>@Localizer["LastAutoSync", lastAutoSyncTime?.ToLocalTime().ToString("g") ?? "Never"]</span>
                                        break;
                                    case AutoSyncStatus.Failed:
                                        <span class="status-icon">‚ùå</span>
                                        <span>@Localizer["SyncFailedRetry"]</span>
                                        break;
                                    default:
                                        <span class="status-icon">‚è≥</span>
                                        <span>@Localizer["WatchingChanges"]</span>
                                        break;
                                }
                            </div>
                        }
                    </div>
                    
                    <div class="signout-section">
                        <button class="link-button signout" @onclick="SignOutFromGoogle">@Localizer["SignOut"]</button>
                    </div>
                }
            </div>
        }
        
        @if (!string.IsNullOrEmpty(statusMessage))
        {
            <div class="status-message @statusClass">
                @statusMessage
            </div>
        }
    </div>

    <!-- About Section -->
    <div class="settings-section">
        <h2 class="section-title">@Localizer["About"]</h2>
        <div class="setting-item">
            <span class="setting-label">@Localizer["Version"]</span>
            <span class="setting-value">1.0.0</span>
        </div>
    </div>

    <!-- Support Section -->
    <div class="settings-section">
        <h2 class="section-title">@Localizer["Support"]</h2>
        <p class="setting-description">@Localizer["SupportDesc"]</p>
        <button class="support-btn" @onclick="OpenBuyMeACoffee">
            <span class="btn-icon">‚òï</span>
            <span>@Localizer["BuyMeACoffee"]</span>
        </button>
    </div>

    <!-- Confirmation Dialogs -->
    <Budgetr.Shared.Components.ConfirmationDialog 
        IsVisible="@showConfirmation1" 
        Title="@Localizer["FactoryReset"]" 
        Message="@Localizer["PromptReset"]" 
        OnClose="OnConfirm1" />
        
    <Budgetr.Shared.Components.ConfirmationDialog 
        IsVisible="@showConfirmation2" 
        Title="@Localizer["FinalWarning"]" 
        Message="@Localizer["FinalWarningMsg"]" 
        OnClose="OnConfirm2" />

    <!-- Danger Zone Section -->
    <div class="settings-section danger-zone">
        <h2 class="section-title">@Localizer["FactoryReset"]</h2>
        <p class="setting-description">@Localizer["FactoryResetDesc"]</p>
        <button class="reset-btn" @onclick="RequestReset">
            <span class="btn-icon">‚ö†Ô∏è</span>
            <span>@Localizer["ResetApp"]</span>
        </button>
    </div>
</div>

@code {
    // ===== Settings (Language/Avatar) State =====
    private bool isDropdownOpen = false;
    private bool isAvatarDropdownOpen = false;

    // ===== Timeular State =====
    private bool isConnectingTimeular;
    private bool isTimeularConnected;
    private string? timeularDeviceName;
    private string? timeularStatusMessage;
    private string timeularStatusClass = "";

    // ===== Sync (Import/Export) State =====
    private ElementReference fileInput;
    private string? selectedFileName;
    private bool isExporting;
    private bool isImporting;
    private string? statusMessage;
    private string statusClass = "";
    
    // Tab state
    private string activeTab = "local";
    
    // Google Drive state
    private bool isGoogleDriveConfigured;
    private bool isGoogleDriveSignedIn;
    private string? googleUserEmail;
    private string? clientIdInput;
    private bool isSigningIn;
    private bool isBackingUp;
    private bool isRestoring;
    private DateTimeOffset? lastBackupTime;
    
    // Auto-sync state
    private bool isAutoSyncEnabled;
    private bool isTogglingAutoSync;
    private AutoSyncStatus autoSyncStatus = AutoSyncStatus.Idle;
    private DateTimeOffset? lastAutoSyncTime;

    private bool IsConfiguredViaFile => !string.IsNullOrEmpty(Configuration["GoogleDrive:ClientId"]) && Configuration["GoogleDrive:ClientId"] != "YOUR_CLIENT_ID_HERE";

    // ===== Reset State =====
    private bool showConfirmation1;
    private bool showConfirmation2;

    // ===== Language Configuration =====
    private string SelectedLanguage => SettingsService.Language;

    private record LanguageOption(string Name, string Code, RenderFragment Flag);

    private static readonly RenderFragment FlagEn = @<svg viewBox="0 0 640 480"><rect width="640" height="480" fill="#012169"/><path d="M75 0l245 180L565 0h75v60L395 240l245 180v60h-75L320 300 75 480H0v-60l245-180L0 60V0h75z" fill="#fff"/><path d="M424 281l216 159v40L369 281h55zM216 199L0 41v40l161 118h55zm0 82L0 439v40l216-159v-40zm208-82l216-159V41L424 199h0z" fill="#C8102E"/><path d="M240 0v480h160V0H240zM0 160v160h640V160H0z" fill="#fff"/><path d="M280 0v480h80V0h-80zM0 200v80h640v-80H0z" fill="#C8102E"/></svg>;
    private static readonly RenderFragment FlagDe = @<svg viewBox="0 0 5 3"><rect width="5" height="3" y="0" fill="#000"/><rect width="5" height="2" y="1" fill="#D00"/><rect width="5" height="1" y="2" fill="#FFCE00"/></svg>;
    private static readonly RenderFragment FlagEs = @<svg viewBox="0 0 750 500"><rect width="750" height="500" fill="#c60b1e"/><rect width="750" height="250" y="125" fill="#ffc400"/><path d="M120 150 a60 60 0 0 0 0 120 v30 a30 30 0 0 0 60 0 v-30 a60 60 0 0 0 0 -120 z" fill="#c60b1e" opacity="0.5"/></svg>;
    private static readonly RenderFragment FlagGl = @<svg viewBox="0 0 3 2"><rect width="3" height="2" fill="#fff"/><path d="M0 2L3 0" stroke="#009edb" stroke-width="0.4"/></svg>;
    private static readonly RenderFragment FlagVo = @<svg viewBox="0 0 2 1"><rect width="2" height="1" fill="#fff"/><rect width="2" height="0.5" y="0.5" fill="#f00"/></svg>;

    private List<LanguageOption> Languages = new()
    {
        new("English", "en", FlagEn),
        new("Deutsch", "de", FlagDe),
        new("Espa√±ol", "es", FlagEs),
        new("Galego", "gl", FlagGl),
        new("Vorarlbergerisch", "gsw", FlagVo)
    };

    private string GetLanguageName(string code) => Languages.FirstOrDefault(l => l.Code == code)?.Name ?? "English";
    private RenderFragment GetFlag(string code) => Languages.FirstOrDefault(l => l.Code == code)?.Flag ?? FlagEn;

    // ===== Lifecycle Methods =====
    protected override void OnInitialized()
    {
        SettingsService.OnSettingsChanged += StateHasChanged;
        TutorialService.OnChange += StateHasChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Subscribe to auto-sync status changes
            AutoSyncService.OnStatusChanged += OnAutoSyncStatusChanged;
            
            await LoadTimeularStateAsync();

            // Try to auto-initialize Google Drive if previously configured
            await TryInitializeGoogleDrive();
        }
    }

    public void Dispose()
    {
        SettingsService.OnSettingsChanged -= StateHasChanged;
        TutorialService.OnChange -= StateHasChanged;
        AutoSyncService.OnStatusChanged -= OnAutoSyncStatusChanged;
    }

    // ===== Settings Methods =====
    private void ToggleDropdown()
    {
        isDropdownOpen = !isDropdownOpen;
    }

    private async Task SelectLanguage(string code)
    {
        if (SelectedLanguage == code) 
        {
            isDropdownOpen = false;
            return;
        }

        await SettingsService.SetLanguageAsync(code);
        isDropdownOpen = false;
        
        // Force reload to apply language changes
        NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
    }

    private void ToggleAvatarDropdown() => isAvatarDropdownOpen = !isAvatarDropdownOpen;
    private string SelectedAvatarName => TutorialService.CurrentAvatar?.Name ?? "Unknown";

    private async Task SelectAvatar(string avatarId)
    {
        await TutorialService.SetAvatarAsync(avatarId);
        isAvatarDropdownOpen = false;
    }

    // ===== Timeular Methods =====
    private async Task LoadTimeularStateAsync()
    {
        try
        {
            var savedState = await JSRuntime.InvokeAsync<TimeularSavedState?>("timeularInterop.getSavedState");
            if (savedState is not null)
            {
                timeularDeviceName = savedState.DeviceName;
                isTimeularConnected = false;
            }
        }
        catch
        {
            // Ignore state restoration errors to avoid blocking settings page
        }
    }

    private async Task ConnectTimeularDevice()
    {
        isConnectingTimeular = true;
        timeularStatusMessage = null;
        StateHasChanged();

        try
        {
            var result = await JSRuntime.InvokeAsync<TimeularConnectResult>("timeularInterop.requestAndConnect");
            if (result.Success)
            {
                isTimeularConnected = true;
                timeularDeviceName = result.DeviceName;
                timeularStatusMessage = $"Connected to {result.DeviceName}.";
                timeularStatusClass = "success";
            }
            else
            {
                isTimeularConnected = false;
                timeularStatusMessage = result.Message ?? "Could not connect to the Timeular device.";
                timeularStatusClass = "error";
            }
        }
        catch (Exception ex)
        {
            isTimeularConnected = false;
            timeularStatusMessage = $"Could not connect to Timeular: {ex.Message}";
            timeularStatusClass = "error";
        }
        finally
        {
            isConnectingTimeular = false;
            StateHasChanged();
        }
    }

    private async Task DisconnectTimeularDevice()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("timeularInterop.disconnect");
            isTimeularConnected = false;
            timeularStatusMessage = "Timeular disconnected.";
            timeularStatusClass = "success";
        }
        catch (Exception ex)
        {
            timeularStatusMessage = $"Could not disconnect from Timeular: {ex.Message}";
            timeularStatusClass = "error";
        }

        StateHasChanged();
    }

    // ===== Data Management - Local Methods =====
    private async Task ExportData()
    {
        isExporting = true;
        statusMessage = null;
        StateHasChanged();

        try
        {
            var json = TimeService.ExportData();
            var filename = $"budgetr-export-{DateTime.Now:yyyy-MM-dd-HHmmss}.json";
            
            await JSRuntime.InvokeVoidAsync("syncInterop.downloadFile", filename, json);
            
            statusMessage = Localizer["SuccessExport"];
            statusClass = "success";
        }
        catch (Exception ex)
        {
            statusMessage = Localizer["ErrorExportFailed", ex.Message];
            statusClass = "error";
        }
        finally
        {
            isExporting = false;
            StateHasChanged();
        }
    }

    private void OnFileSelected(ChangeEventArgs e)
    {
        selectedFileName = e.Value?.ToString();
        statusMessage = null;
        StateHasChanged();
    }

    private async Task ImportData()
    {
        isImporting = true;
        statusMessage = null;
        StateHasChanged();

        try
        {
            var content = await JSRuntime.InvokeAsync<string>("syncInterop.readFileContent", fileInput);
            await TimeService.ImportDataAsync(content);
            
            statusMessage = Localizer["SuccessImport"];
            statusClass = "success";
            selectedFileName = null;
        }
        catch (Exception ex)
        {
            statusMessage = Localizer["ErrorImportFailed", ex.Message];
            statusClass = "error";
        }
        finally
        {
            isImporting = false;
            StateHasChanged();
        }
    }

    // ===== Data Management - Google Drive Methods =====
    private async Task TryInitializeGoogleDrive()
    {
        try
        {
            if (IsConfiguredViaFile)
            {
                clientIdInput = Configuration["GoogleDrive:ClientId"];
                await JSRuntime.InvokeVoidAsync("googleDriveInterop.initialize", clientIdInput);
                isGoogleDriveConfigured = true;
            }
            else
            {
                var savedClientId = await JSRuntime.InvokeAsync<string?>("localStorage.getItem", "budgetr_gdrive_clientid");
                if (!string.IsNullOrEmpty(savedClientId))
                {
                    await JSRuntime.InvokeVoidAsync("googleDriveInterop.initialize", savedClientId);
                    isGoogleDriveConfigured = true;
                }
            }

            if (isGoogleDriveConfigured)
            {
                isGoogleDriveSignedIn = await JSRuntime.InvokeAsync<bool>("googleDriveInterop.isSignedIn");
                
                if (isGoogleDriveSignedIn)
                {
                    googleUserEmail = await JSRuntime.InvokeAsync<string?>("googleDriveInterop.getUserEmail");
                    await RefreshBackupInfo();
                    RefreshAutoSyncState();
                }
                
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to auto-initialize Google Drive: {ex.Message}");
        }
    }

    private async Task SwitchToGoogleDrive()
    {
        activeTab = "gdrive";
        statusMessage = null;
        
        if (isGoogleDriveConfigured && isGoogleDriveSignedIn)
        {
            await RefreshBackupInfo();
        }
    }

    private async Task ConfigureGoogleDrive()
    {
        if (!IsConfiguredViaFile && string.IsNullOrWhiteSpace(clientIdInput))
            return;
            
        statusMessage = null;
        
        try
        {
            if (!IsConfiguredViaFile)
            {
                await JSRuntime.InvokeVoidAsync("localStorage.setItem", "budgetr_gdrive_clientid", clientIdInput);
            }
            
            await JSRuntime.InvokeVoidAsync("googleDriveInterop.initialize", clientIdInput);
            isGoogleDriveConfigured = true;
            statusMessage = Localizer["SuccessGDriveConfig"];
            statusClass = "success";
        }
        catch (Exception ex)
        {
            statusMessage = Localizer["ErrorConfigFailed", ex.Message];
            statusClass = "error";
        }
    }

    private void ShowReconfigure()
    {
        isGoogleDriveConfigured = false;
        clientIdInput = null;
        statusMessage = null;
    }

    private async Task SignInWithGoogle()
    {
        isSigningIn = true;
        statusMessage = null;
        StateHasChanged();
        
        try
        {
            var success = await JSRuntime.InvokeAsync<bool>("googleDriveInterop.signIn");
            if (success)
            {
                isGoogleDriveSignedIn = true;
                googleUserEmail = await JSRuntime.InvokeAsync<string?>("googleDriveInterop.getUserEmail");
                await RefreshBackupInfo();
                statusMessage = Localizer["SuccessSignIn"];
                statusClass = "success";
            }
            else
            {
                statusMessage = Localizer["ErrorSignInCancelled"];
                statusClass = "error";
            }
        }
        catch (Exception ex)
        {
            statusMessage = Localizer["ErrorSignInFailed", ex.Message];
            statusClass = "error";
        }
        finally
        {
            isSigningIn = false;
            StateHasChanged();
        }
    }

    private async Task SignOutFromGoogle()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("googleDriveInterop.signOut");
            isGoogleDriveSignedIn = false;
            googleUserEmail = null;
            lastBackupTime = null;
            
            // Disable auto-sync when signing out
            if (isAutoSyncEnabled)
            {
                await AutoSyncService.DisableAsync();
                isAutoSyncEnabled = false;
            }
            
            statusMessage = Localizer["SuccessSignOut"];
            statusClass = "success";
        }
        catch (Exception ex)
        {
            statusMessage = Localizer["ErrorSignOutFailed", ex.Message];
            statusClass = "error";
        }
        StateHasChanged();
    }

    private async Task RefreshBackupInfo()
    {
        try
        {
            var lastModified = await JSRuntime.InvokeAsync<string?>("googleDriveInterop.getBackupLastModified");
            if (!string.IsNullOrEmpty(lastModified) && DateTimeOffset.TryParse(lastModified, out var parsed))
            {
                lastBackupTime = parsed;
            }
            else
            {
                lastBackupTime = null;
            }
        }
        catch
        {
            lastBackupTime = null;
        }
    }

    private async Task BackupToGoogleDrive()
    {
        isBackingUp = true;
        statusMessage = null;
        StateHasChanged();
        
        try
        {
            var json = TimeService.ExportData();
            await JSRuntime.InvokeVoidAsync("googleDriveInterop.saveBackup", json);
            await RefreshBackupInfo();
            statusMessage = Localizer["SuccessBackup"];
            statusClass = "success";
        }
        catch (Exception ex)
        {
            statusMessage = Localizer["ErrorBackupFailed", ex.Message];
            statusClass = "error";
        }
        finally
        {
            isBackingUp = false;
            StateHasChanged();
        }
    }

    private async Task RestoreFromGoogleDrive()
    {
        isRestoring = true;
        statusMessage = null;
        StateHasChanged();
        
        try
        {
            var content = await JSRuntime.InvokeAsync<string?>("googleDriveInterop.getLatestBackup");
            
            if (string.IsNullOrEmpty(content))
            {
                statusMessage = Localizer["ErrorNoBackup"];
                statusClass = "error";
            }
            else
            {
                await TimeService.ImportDataAsync(content);
                statusMessage = Localizer["SuccessRestore"];
                statusClass = "success";
            }
        }
        catch (Exception ex)
        {
            statusMessage = Localizer["ErrorRestoreFailed", ex.Message];
            statusClass = "error";
        }
        finally
        {
            isRestoring = false;
            StateHasChanged();
        }
    }

    // Auto-sync methods
    private async Task OnAutoSyncToggled(ChangeEventArgs e)
    {
        var newValue = (bool)(e.Value ?? false);
        isTogglingAutoSync = true;
        StateHasChanged();
        
        try
        {
            if (newValue)
            {
                await AutoSyncService.EnableAsync();
                isAutoSyncEnabled = true;
                statusMessage = Localizer["SuccessAutoSyncEnabled"];
                statusClass = "success";
            }
            else
            {
                await AutoSyncService.DisableAsync();
                isAutoSyncEnabled = false;
                statusMessage = Localizer["SuccessAutoSyncDisabled"];
                statusClass = "success";
            }
        }
        catch (Exception ex)
        {
            statusMessage = Localizer["ErrorToggleAutoSync", ex.Message];
            statusClass = "error";
        }
        finally
        {
            isTogglingAutoSync = false;
            StateHasChanged();
        }
    }

    private void OnAutoSyncStatusChanged(AutoSyncStatus status)
    {
        autoSyncStatus = status;
        lastAutoSyncTime = AutoSyncService.LastSyncTime;
        InvokeAsync(StateHasChanged);
    }

    private void RefreshAutoSyncState()
    {
        isAutoSyncEnabled = AutoSyncService.IsEnabled;
        autoSyncStatus = AutoSyncService.Status;
        lastAutoSyncTime = AutoSyncService.LastSyncTime;
    }

    private string GetAutoSyncStatusClass()
    {
        return autoSyncStatus switch
        {
            AutoSyncStatus.Syncing => "syncing",
            AutoSyncStatus.Success => "success",
            AutoSyncStatus.Failed => "error",
            _ => "idle"
        };
    }

    // ===== Support Methods =====
    private async Task OpenBuyMeACoffee()
    {
        await JSRuntime.InvokeVoidAsync("open", "https://www.buymeacoffee.com/albertogregorio", "_blank");
    }

    // ===== Reset Methods =====
    private void RequestReset()
    {
        showConfirmation1 = true;
        StateHasChanged();
    }

    private void OnConfirm1(bool confirmed)
    {
        showConfirmation1 = false;
        if (confirmed)
        {
            showConfirmation2 = true;
        }
        StateHasChanged();
    }

    private async Task OnConfirm2(bool confirmed)
    {
        showConfirmation2 = false;
        if (confirmed)
        {
            await PerformReset();
        }
        StateHasChanged();
    }

    private async Task PerformReset()
    {
        try 
        {
            // 1. Reset Time/Meter Data
            await TimeService.ResetDataAsync();
            
            // 2. Reset Tutorial
            await TutorialService.ResetTutorialAsync();
            
            // 3. Navigate to Home to start fresh (and trigger tutorial)
            NavigationManager.NavigateTo("", forceLoad: true);
        }
        catch (Exception)
        {
            // Error handling can be added here if needed
        }
    }

    private sealed class TimeularSavedState
    {
        public string? DeviceName { get; set; }
        public string? DeviceId { get; set; }
        public string? ConnectedAtUtc { get; set; }
    }

    private sealed class TimeularConnectResult
    {
        public bool Success { get; set; }
        public string? DeviceName { get; set; }
        public string? DeviceId { get; set; }
        public string? Message { get; set; }
    }
}
